# ============================================================
# Basic Configuration | 基础配置
# ============================================================

# Enable rule engine (blocking mode) | 启用规则引擎(拦截模式)
SecRuleEngine On
# SecRuleEngine DetectionOnly

# Enable request body inspection | 启用请求体检测
SecRequestBodyAccess On

# Disable response body inspection (better performance) | 关闭响应体检测(提升性能)
SecResponseBodyAccess Off

# Maximum request body size (10MB) | 请求体最大大小 (10MB)
SecRequestBodyLimit 10485760

# Request body size limit without files (1MB) | 不包含文件的请求体大小限制 (1MB)
SecRequestBodyNoFilesLimit 1048576

# Debug log level (0–9, higher means more verbose) | 调试日志级别(0–9, 数字越大日志越详细)
SecDebugLogLevel 3
SecDebugLog logs/debug.log

# Enable audit logging | 启用审计日志
SecAuditEngine On
# SecAuditEngine RelevantOnly

# Audit log file path | 审计日志文件路径
SecAuditLog logs/audit.log

# Audit log parts | 审计日志记录内容片段
SecAuditLogParts ABIJDEFHZ

# ============================================================
# Recommended Core Rules | 官方推荐基础规则
# ============================================================

# Parse request body as JSON when Content-Type is application/json
# 当 Content-Type 为 application/json 时按 JSON 解析请求体
#
# Test (allowed) | 测试 (放行):
# curl -X POST \
#  -H "Content-Type: application/json" \
#  -d "{\"id\":1}" \
#  "http://IP:PORT/path"
SecRule REQUEST_HEADERS:Content-Type "^application/json" \
"id:210001,phase:1,pass,nolog,ctl:requestBodyProcessor=JSON"

# Block requests when request body parsing fails | 当请求体解析失败时进行拦截
#
# Test (blocked) | 测试 (拦截):
# curl -X POST \
#  -H "Content-Type: application/json" \
#  -d "{\"id\":1" \
#  "http://IP:PORT/path"
SecRule REQBODY_ERROR "!@eq 0" \
"id:210002,phase:2,log,deny,status:400,msg:'Failed to parse request body',severity:2"

# Limit total number of request parameters | 限制请求参数数量
#
# Test (blocked) | 测试 (拦截):
# curl "http://IP:PORT/path?a=1&b=1&c=1&d=1&e=1&f=1&g=1&h=1&i=1&j=1&k=1&l=1&m=1&n=1&o=1&p=1&q=1&r=1&s=1&t=1&u=1"
SecRule &ARGS "@gt 20" \
"id:210003,phase:2,deny,status:403,msg:'Too many parameters'"

# Block requests with excessively long URI | 拦截 URI 长度异常的请求
SecRule REQUEST_URI "@gt 100" \
"id:210004,phase:1,deny,status:414,msg:'Request URI too long'"

# ============================================================
# Basic Protection Rules | 基础防护规则
# ============================================================

# Detect common scanners and automated tools | 检测常见扫描器与自动化攻击工具
# sqlmap | nikto | acunetix | nessus | masscan | nmap | fuzz | dirbuster | gobuster
#
# Test (blocked) | 测试 (拦截):
# curl -A "sqlmap" "http://IP:PORT/path"
# curl -A "nmap" "http://IP:PORT/path"
SecRule REQUEST_HEADERS:User-Agent "@rx (?i)(sqlmap|nikto|acunetix|nessus|masscan|nmap|fuzz|dirbuster|gobuster)" \
"id:200001,phase:1,deny,status:403,msg:'Scanner or automated tool detected'"

# SQL Injection detection | SQL 注入检测
#
# Test (blocked) | 测试 (拦截):
# curl "http://IP:PORT/path?id=1%20union%20select%201"
SecRule ARGS "@rx (?i)(union\s+select|select.+from|insert\s+into|update.+set|delete\s+from|or\s+1=1|sleep\(|benchmark\()" \
"id:200002,phase:2,deny,status:403,msg:'SQL Injection detected'"

# Cross-Site Scripting (XSS) detection | XSS (跨站脚本攻击) 检测
#
# Test (blocked) | 测试 (拦截):
# curl "http://IP:PORT/path?name=%3Cscript%3Ealert(1)%3C/script%3E"
SecRule ARGS "@rx (?i)(<script|<img|javascript:|onerror=|onload=|alert\()" \
"id:200003,phase:2,deny,status:403,msg:'XSS detected'"

# Command injection detection | 命令注入检测
#
# Test (blocked) | 测试 (拦截):
# curl "http://IP:PORT/path?cmd=ls;whoami"
# curl "http://IP:PORT/path?cmd=cmd.exe%20/c%20dir"
SecRule ARGS "@rx (?i)(;|\|\||&&|`|\$\(|\b(cmd|powershell|bash|sh|curl|wget)\b)" \
"id:200004,phase:2,deny,status:403,msg:'Command injection detected'"

# Path traversal detection | 路径穿越攻击检测
#
# Test (blocked) | 测试 (拦截):
# curl "http://IP:PORT/path/%2e%2e/%2e%2e/windows/system32"
SecRule REQUEST_URI|REQUEST_URI_RAW "@rx (\.\./|%2e%2e|%252e%252e)" \
"id:200005,phase:1,deny,status:403,msg:'Path traversal detected'"

# Invalid HTTP method detection | 非法 HTTP 方法检测
#
# Test (blocked) | 测试 (拦截):
# curl -X TRACE "http://IP:PORT/path"
SecRule REQUEST_METHOD "!^(GET|POST|PUT|DELETE|PATCH|OPTIONS)$" \
"id:200006,phase:1,deny,status:405,msg:'Invalid HTTP method'"

# Invalid Content-Type detection | 非法 Content-Type 检测
#
# Test (blocked) | 测试 (拦截):
# curl -X POST \
#  -H "Content-Type: text/plain" \
#  -d "test" \
#  "http://IP:PORT/path"
SecRule REQUEST_HEADERS:Content-Type "!@rx (?i)^(application/json|application/x-www-form-urlencoded|multipart/form-data)" \
"id:200007,phase:1,deny,status:415,msg:'Invalid Content-Type'"

# Malicious keywords in JSON request body | JSON 请求体中的危险关键字检测
#
# Test (blocked) | 测试 (拦截):
# curl -X POST \
#  -H "Content-Type: application/json" \
#  -d "{\"id\":\"1 union select 1\"}" \
#  "http://IP:PORT/path"
SecRule REQUEST_HEADERS:Content-Type "@contains application/json" \
"id:200008,phase:2,pass,nolog,chain"
    SecRule REQUEST_BODY "@rx (?i)(union\s+select|<script|;|\|\||&&)" \
    "deny,status:403,msg:'Malicious JSON body detected'"

# ============================================================
# Business-Specific Rules | 业务专属规则
# ============================================================

# Allow /api/user/* without restriction 放行 /api/user/* 接口
SecRule REQUEST_URI "^/api/user/" "id:299999,phase:1,pass"

# Allow /api/shop/* without restriction 放行 /api/shop/* 接口
SecRule REQUEST_URI "^/api/shop/" "id:299998,phase:1,pass"
